<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- 原有head內容保持不變 -->
</head>
<body>
    <!-- 原有HTML結構保持不變 -->
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById('loader');
            loader.addEventListener('animationend', () => {
                loader.style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('predictionContainer').style.display = 'none';
            });
        });

        function getUserIP() {
            return fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => data.ip)
                .catch(() => '無法獲取IP');
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert("請輸入帳號和密碼！");
                return;
            }

            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';

            try {
                // 獲取使用者IP
                const ip = await getUserIP();
                
                // 連接到Google Apps Script驗證
                const url = 'https://script.google.com/macros/s/AKfycbwy19QjkUjCRCZzwl3g2gVhQUDaGQMepKj4ZjkpCha2PIsgtnFrqYI18-WZE-XcthppXw/exec';
                const response = await fetch(`${url}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&ip=${encodeURIComponent(ip)}`);
                const result = await response.text();

                if (result === 'success') {
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('predictionContainer').style.display = 'flex';
                        initGrid();
                    }, 1000);
                } else {
                    alert('帳號或密碼錯誤！');
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'flex';
                }
            } catch (error) {
                console.error('登入錯誤:', error);
                alert('連線錯誤，請稍後再試！');
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
            }
        }

        // 防止修改功能
        function preventModification() {
            const inputs = document.querySelectorAll('.cell, .prediction-display, .probability');
            inputs.forEach(input => {
                input.setAttribute('readonly', 'true');
                input.style.pointerEvents = 'none';
            });
        }

        let pages = [[]];
        let currentPage = 0;
        const gridSize = 30;
        let stats = { total: 0, 莊: 0, 閒: 0, 和: 0, '6': 0 };

        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for (let i = 0; i < gridSize; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                grid.appendChild(cell);
            }
            updateGrid();
            updateStatsDisplay();
            preventModification(); // 防止修改
        }

        // 修改addResult為只讀模式
        function addResult(type) {
            alert('此為唯讀模式，無法新增紀錄');
            return;
        }

        // 修改resetResults為只讀模式
        function resetResults() {
            alert('此為唯讀模式，無法重置');
            return;
        }

        // 修改undoResult為只讀模式
        function undoResult() {
            alert('此為唯讀模式，無法復原');
            return;
        }

        // 其餘函數保持不變，但移除修改相關邏輯
        function updateGrid() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'cell';
            });
            const currentResults = pages[currentPage];
            for (let i = 0; i < currentResults.length; i++) {
                const col = Math.floor(i / 6);
                const row = i % 6;
                const cellIndex = row * 5 + col;
                if (cellIndex < gridSize) {
                    cells[cellIndex].textContent = currentResults[i];
                    if (currentResults[i] === '莊') cells[cellIndex].classList.add('red');
                    else if (currentResults[i] === '閒') cells[cellIndex].classList.add('blue');
                    else if (currentResults[i] === '和') cells[cellIndex].classList.add('green');
                    else if (currentResults[i] === '6') cells[cellIndex].classList.add('red');
                }
            }
            preventModification();
        }

        function updateStats(type, delta) {
            // 只讀模式不更新統計
        }

        function recalculateStats() {
            // 只讀模式不重新計算
        }

        function updateStatsDisplay() {
            document.getElementById('stats').textContent = 
                `局數: ${stats.total}, 莊: ${stats.莊}, 閒: ${stats.閒}, 和: ${stats.和}, 6: ${stats['6']}`;
        }

        function predict() {
            // 預測功能保持不變
            const predictionDiv = document.getElementById('prediction');
            const probabilityDiv = document.getElementById('probability');

            predictionDiv.textContent = '讀取中...';
            setTimeout(() => {
                const randomNum = Math.floor(Math.random() * 101);
                let prediction = randomNum <= 45 ? '閒' : randomNum <= 90 ? '莊' : '和';

                const maxProb = Math.floor(Math.random() * 31 + 60);
                const tieProb = Math.floor(Math.random() * 31);
                const remainingProb = Math.max(0, 100 - maxProb - tieProb);

                let probs = { 莊: 0, 閒: 0, 和: 0 };
                if (prediction === '莊') {
                    probs.莊 = maxProb;
                    probs.閒 = remainingProb;
                    probs.和 = tieProb;
                } else if (prediction === '閒') {
                    probs.閒 = maxProb;
                    probs.莊 = remainingProb;
                    probs.和 = tieProb;
                } else {
                    probs.和 = tieProb;
                    const baseProb = Math.floor((100 - tieProb) / 2);
                    probs.莊 = baseProb + (100 - tieProb) % 2;
                    probs.閒 = baseProb;
                }

                predictionDiv.textContent = prediction;
                if (prediction === '莊') {
                    predictionDiv.style.color = '#ff3333';
                } else if (prediction === '閒') {
                    predictionDiv.style.color = '#3333ff';
                } else if (prediction === '和') {
                    predictionDiv.style.color = '#33ff33';
                }

                probabilityDiv.textContent = 
                    `機率: 莊 ${probs.莊}%, 閒 ${probs.閒}%, 和 ${probs.和}%`;
            }, 1000);
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                updateGrid();
                updatePageControls();
            }
        }

        function nextPage() {
            if (currentPage < pages.length - 1) {
                currentPage++;
                updateGrid();
                updatePageControls();
            }
        }

        function updatePageControls() {
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage === pages.length - 1;
        }
    </script>
</body>
</html>