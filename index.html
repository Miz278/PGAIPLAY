<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PG預測系統 V1.94 (手機版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #0d0d0d, #1a1a1a, #0d0d0d);
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
            animation: bgShift 10s infinite alternate;
            touch-action: manipulation;
        }
        @keyframes bgShift {
            from { background-position: 0% 0%; }
            to { background-position: 100% 100%; }
        }
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
        }
        .login-container h2 {
            font-size: 24px;
            color: #ff9800;
            text-shadow: 0 0 10px #ff9800;
            margin-bottom: 20px;
        }
        .login-form {
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
            width: 90%;
            max-width: 300px;
        }
        .login-form input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: #2a2a2a;
            color: #fff;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
        }
        .login-form button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(255, 152, 0, 0.5);
            transition: all 0.2s;
            width: 100%;
            touch-action: manipulation;
        }
        .login-form button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px #ff9800, 0 0 18px #ff5722;
        }
        .header {
            background: linear-gradient(135deg, #000, #1a1a1a);
            color: #ff9800;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #ff9800;
            text-shadow: 0 0 10px #ff9800, 0 0 15px #ff5722;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
            background: linear-gradient(45deg, #ff9800, #ffeb3b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px #ff9800, 0 0 20px #ff5722;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 8px #ff9800, 0 0 12px #ff5722; }
            to { text-shadow: 0 0 12px #ffeb3b, 0 0 18px #ff5722; }
        }
        .container {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 10px;
            overflow: auto;
        }
        .prediction-panel {
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
            border: 2px solid #ff9800;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
            margin-bottom: 10px;
            flex: 0.3;
            position: relative;
            overflow: hidden;
        }
        .grid-panel {
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
            border: 2px solid #ff9800;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
            flex: 0.7;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }
        .prediction-display {
            font-size: 24px;
            text-align: center;
            text-shadow: 0 0 15px #fff, 0 0 25px #ff9800;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.3), rgba(255, 87, 34, 0.3));
            border: 2px solid #ffeb3b;
            border-radius: 8px;
            margin: 8px 0;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 12px rgba(255, 235, 59, 0.7), 0 0 20px rgba(255, 152, 0, 0.5);
            animation: fadeInOut 1.5s ease-in-out infinite;
            font-weight: bold;
        }
        @keyframes fadeInOut {
            0% { opacity: 0.7; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.7; transform: scale(0.95); }
        }
        .probability {
            font-size: 16px;
            text-align: center;
            color: #fff;
            margin: 8px 0;
            text-shadow: 0 0 8px #ffeb3b, 0 0 12px #ff9800;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 6px;
            position: relative;
            z-index: 1;
            font-weight: bold;
            animation: colorChange 3s infinite alternate;
        }
        @keyframes colorChange {
            from { color: #fff; }
            to { color: #ffeb3b; }
        }
        h2 {
            font-size: 16px;
            text-align: center;
            margin: 8px 0;
            color: #ff9800;
            text-shadow: 0 0 8px #ff9800;
            position: relative;
            z-index: 1;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(5, 24px);
            grid-template-rows: repeat(6, 24px);
            gap: 4px;
            justify-content: center;
            margin-bottom: 5px;
            flex: 1;
        }
        .cell {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2a2a2a;
            border: 1px solid #ff9800;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 10px;
            box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
            transition: all 0.3s;
        }
        .cell.red { 
            background: #ff3333; 
            box-shadow: 0 0 8px #ff3333, 0 0 12px #ff0000; 
            border-color: #ff5722;
        }
        .cell.blue { 
            background: #3333ff; 
            box-shadow: 0 0 8px #3333ff, 0 0 12px #0000ff; 
            border-color: #3f51b5;
        }
        .cell.green { 
            background: #33ff33; 
            box-shadow: 0 0 8px #33ff33, 0 0 12px #00ff00; 
            border-color: #4caf50;
        }
        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin-top: 5px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(255, 152, 0, 0.5);
            transition: all 0.2s;
            min-width: 60px;
            touch-action: manipulation;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px #ff9800, 0 0 18px #ff5722;
        }
        .reset-btn { 
            background: linear-gradient(135deg, #333, #1a1a1a); 
            color: #ff9800;
        }
        .undo-btn { 
            background: linear-gradient(135deg, #ffeb3b, #ffc107); 
            color: #000;
        }
        .red-btn { background: linear-gradient(135deg, #ff3333, #d32f2f); }
        .blue-btn { background: linear-gradient(135deg, #3333ff, #1976d2); }
        .green-btn { background: linear-gradient(135deg, #33ff33, #2e7d32); }
        #stats {
            text-align: center;
            margin: 5px 0;
            color: #fff;
            font-size: 12px;
            text-shadow: 0 0 4px #ff9800;
        }
        .page-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .page-btn {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(255, 152, 0, 0.5);
            transition: all 0.2s;
            min-width: 80px;
            touch-action: manipulation;
        }
        .page-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px #ff9800, 0 0 18px #ff5722;
        }
        .page-btn:disabled {
            background: linear-gradient(135deg, #333, #1a1a1a);
            color: #666;
            cursor: not-allowed;
        }
        @media (min-width: 601px) {
            .header h1 { font-size: 28px; }
            .prediction-display { 
                font-size: 30px; 
                padding: 15px;
                border-width: 3px;
                box-shadow: 0 0 15px rgba(255, 235, 59, 0.8), 0 0 25px rgba(255, 152, 0, 0.6);
            }
            .probability { 
                font-size: 18px;
                padding: 10px;
                text-shadow: 0 0 10px #ffeb3b, 0 0 15px #ff9800;
            }
            h2 { font-size: 18px; }
            .login-container h2 { font-size: 28px; }
            .login-form { max-width: 400px; }
            .grid { grid-template-columns: repeat(5, 28px); grid-template-rows: repeat(6, 28px); }
            .cell { width: 28px; height: 28px; font-size: 12px; }
            button { font-size: 16px; padding: 12px 18px; min-width: 70px; }
            .page-btn { font-size: 16px; padding: 12px 18px; min-width: 90px; }
            #stats { font-size: 14px; }
        }
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 2s forwards;
        }
        .loader::after {
            content: '';
            width: 50px;
            height: 50px;
            border: 5px solid #ff9800;
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 12px #ff9800, 0 0 20px #ff5722;
        }
        .prediction-loader {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid #ff9800;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 2;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader"></div>
    <div class="login-container" id="loginContainer">
        <h2>登入系統</h2>
        <div class="login-form">
            <input type="text" id="username" placeholder="帳號" required>
            <input type="password" id="password" placeholder="密碼" required>
            <button onclick="login()">登入</button>
        </div>
    </div>

    <div class="header">
        <h1>PG預測系統 V1.94 (手機版)</h1>
    </div>
    <div class="container" id="predictionContainer">
        <section class="prediction-panel">
            <h2>下局預測</h2>
            <div class="prediction-display" id="prediction">
                等待預測...
                <div class="prediction-loader" id="prediction-loader"></div>
            </div>
            <div class="probability" id="probability">機率: 莊 0%, 閒 0%, 和 0%</div>
        </section>

        <section class="grid-panel">
            <div class="page-controls">
                <button class="page-btn" id="prevPage" onclick="prevPage()" disabled>上一頁</button>
                <button class="page-btn" id="nextPage" onclick="nextPage()">下一頁</button>
            </div>
            <h2>珠盤路</h2>
            <div class="grid" id="grid"></div>
            <div class="input-buttons">
                <div class="button-group">
                    <button class="red-btn" onclick="addResult('莊')">莊</button>
                    <button class="blue-btn" onclick="addResult('閒')">閒</button>
                    <button class="green-btn" onclick="addResult('和')">和</button>
                    <button class="red-btn" onclick="addResult('6')">6</button>
                </div>
                <div class="button-group">
                    <button class="reset-btn" onclick="resetResults()">重置</button>
                    <button class="undo-btn" onclick="undoResult()">復原</button>
                </div>
            </div>
            <div id="stats">局數: 0, 莊: 0, 閒: 0, 和: 0, 6: 0</div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.addEventListener('animationend', () => {
                    loader.style.display = 'none';
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.getElementById('predictionContainer').style.display = 'none';
                });
            } else {
                console.error('Loader element not found');
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('predictionContainer').style.display = 'none';
            }
        });

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert("請輸入帳號和密碼！");
                return;
            }

            const data = {
                username: username,
                password: password
            };

            fetch('https://script.google.com/macros/s/AKfycbzZeyY9ylDJM73JhmDvleprBcj-aFtoXxi9joGU8NBNAqZwrfPEn7UO-anbQJ92Pxt7/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                mode: 'no-cors'
            })
            .then(response => {
                console.log('請求送出，假設成功');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('predictionContainer').style.display = 'flex';
                initGrid();
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert(`發生錯誤: ${error.message}`);
            });
        }

        let pages = [[]];
        let currentPage = 0;
        const gridSize = 30;
        let stats = { total: 0, 莊: 0, 閒: 0, 和: 0, '6': 0 };

        function initGrid() {
            const grid = document.getElementById('grid');
            if (!grid) {
                console.error('Grid element not found');
                return;
            }
            grid.innerHTML = '';
            for (let i = 0; i < gridSize; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                grid.appendChild(cell);
            }
            updateGrid();
            updateStatsDisplay();
        }

        function addResult(type) {
            if (pages[currentPage].length >= gridSize) {
                pages.push([]);
                currentPage++;
                handleResultsChange();
            }
            pages[currentPage].push(type);
            updateStats(type, 1);
            updateGrid();
            updatePageControls();
            if (currentPage > 0 || pages[currentPage].length >= 1) {
                predict();
            }
        }

        function resetResults() {
            pages = [[]];
            currentPage = 0;
            stats = { total: 0, 莊: 0, 閒: 0, 和: 0, '6': 0 };
            const grid = document.getElementById('grid');
            if (grid) {
                grid.innerHTML = '';
                for (let i = 0; i < gridSize; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    grid.appendChild(cell);
                }
            }
            updateGrid();
            updateStatsDisplay();
            handleResultsChange();
            updatePageControls();
        }

        function undoResult() {
            if (pages[currentPage].length > 0) {
                const removed = pages[currentPage].pop();
                updateStats(removed, -1);
            } else if (currentPage > 0) {
                pages.pop();
                currentPage--;
                recalculateStats();
            }
            updateGrid();
            updateStatsDisplay();
            handleResultsChange();
            updatePageControls();
        }

        function handleResultsChange() {
            const prediction = document.getElementById('prediction');
            const probability = document.getElementById('probability');
            const predictionLoader = document.getElementById('prediction-loader');
            if (prediction) {
                prediction.textContent = '等待預測...';
                prediction.style.color = '#ffeb3b';
            }
            if (probability) probability.textContent = '機率: 莊 0%, 閒 0%, 和 0%';
            if (predictionLoader) predictionLoader.style.display = 'none';
        }

        function updateGrid() {
            const cells = document.querySelectorAll('.cell');
            if (!cells.length) {
                console.error('No cells found in grid');
                return;
            }
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'cell';
            });
            const currentResults = pages[currentPage];
            for (let i = 0; i < currentResults.length; i++) {
                const col = Math.floor(i / 6);
                const row = i % 6;
                const cellIndex = row * 5 + col;
                if (cellIndex < gridSize && cells[cellIndex]) {
                    cells[cellIndex].textContent = currentResults[i];
                    if (currentResults[i] === '莊') cells[cellIndex].classList.add('red');
                    else if (currentResults[i] === '閒') cells[cellIndex].classList.add('blue');
                    else if (currentResults[i] === '和') cells[cellIndex].classList.add('green');
                    else if (currentResults[i] === '6') cells[cellIndex].classList.add('red');
                }
            }
        }

        function updateStats(type, delta) {
            stats.total += delta;
            if (type === '莊') stats.莊 += delta;
            else if (type === '閒') stats.閒 += delta;
            else if (type === '和') stats.和 += delta;
            else if (type === '6') stats['6'] += delta;
            updateStatsDisplay();
        }

        function recalculateStats() {
            stats = { total: 0, 莊: 0, 閒: 0, 和: 0, '6': 0 };
            pages.forEach(page => {
                page.forEach(r => {
                    stats.total++;
                    if (r === '莊') stats.莊++;
                    else if (r === '閒') stats.閒++;
                    else if (r === '和') stats.和++;
                    else if (r === '6') stats['6']++;
                });
            });
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            const statsDiv = document.getElementById('stats');
            if (statsDiv) {
                statsDiv.textContent = 
                    `局數: ${stats.total}, 莊: ${stats.莊}, 閒: ${stats.閒}, 和: ${stats.和}, 6: ${stats['6']}`;
            }
        }

        function predict() {
            const predictionDiv = document.getElementById('prediction');
            const probabilityDiv = document.getElementById('probability');
            const predictionLoader = document.getElementById('prediction-loader');

            if (predictionDiv) {
                predictionDiv.textContent = '讀取中...';
                predictionDiv.style.color = '#ffeb3b';
            }
            if (predictionLoader) predictionLoader.style.display = 'block';
            if (probabilityDiv) probabilityDiv.textContent = '機率: 莊 0%, 閒 0%, 和 0%';

            setTimeout(() => {
                const randomNum = Math.floor(Math.random() * 101); // 0 to 100
                let prediction;

                if (randomNum <= 45) prediction = '閒';
                else if (randomNum <= 90) prediction = '莊';
                else prediction = '和';

                const maxProb = Math.floor(Math.random() * (90 - 60 + 1) + 60); // 60% to 90%
                const tieProb = Math.floor(Math.random() * 31); // 0% to 30%
                const remainingProb = Math.max(0, 100 - maxProb - tieProb); // 確保不為負

                let probs = { 莊: 0, 閒: 0, 和: 0 };
                if (prediction === '莊') {
                    probs.莊 = maxProb;
                    probs.閒 = remainingProb;
                    probs.和 = tieProb;
                } else if (prediction === '閒') {
                    probs.閒 = maxProb;
                    probs.莊 = remainingProb;
                    probs.和 = tieProb;
                } else {
                    probs.和 = tieProb;
                    const baseProb = Math.floor((100 - tieProb) / 2);
                    const remainder = (100 - tieProb) % 2;
                    probs.莊 = baseProb + remainder;
                    probs.閒 = baseProb;
                }

                if (predictionDiv) {
                    predictionDiv.textContent = prediction;
                    if (prediction === '莊') predictionDiv.style.color = '#ff3333';
                    else if (prediction === '閒') predictionDiv.style.color = '#3333ff';
                    else if (prediction === '和') predictionDiv.style.color = '#33ff33';
                }
                if (probabilityDiv) {
                    probabilityDiv.textContent = 
                        `機率: 莊 ${probs.莊}%, 閒 ${probs.閒}%, 和 ${probs.和}%`;
                }
                if (predictionLoader) predictionLoader.style.display = 'none';
            }, 1000);
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                updateGrid();
                updatePageControls();
                handleResultsChange();
            }
        }

        function nextPage() {
            if (currentPage < pages.length - 1 || pages[currentPage].length > 0) {
                if (currentPage === pages.length - 1) pages.push([]);
                currentPage++;
                updateGrid();
                updatePageControls();
                handleResultsChange();
            }
        }

        function updatePageControls() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            if (prevBtn) prevBtn.disabled = currentPage === 0;
            if (nextBtn) nextBtn.disabled = currentPage === pages.length - 1 && pages[currentPage].length === 0;
        }
    </script>
</body>
</html>